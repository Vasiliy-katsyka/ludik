<!DOCTYPE html> 
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ludik Gifts - Full Feature</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/sdk@latest/dist/tonconnect-sdk.min.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MSDGWEGLR0"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-MSDGWEGLR0');
    </script>
    <style>
        :root {
            --bg-gradient-start: #181A25; --bg-gradient-mid: #202333; --bg-gradient-end: #12141D;
            --surface-color: #282B3D; --surface-hover-color: #31354A;
            --primary-color: #007AFF; --primary-gradient-start: #007AFF; --primary-gradient-end: #34AADC;
            --secondary-color: #FF9500; --text-primary: #F5F5F7; --text-secondary: #AEB4C0;
            --text-placeholder: #7A7F8F; --text-price-color: #C7CDD6;
            --border-color: rgba(120, 120, 128, 0.25); --border-highlight: var(--primary-color);
            --danger-color: #FF3B30; --success-color: #30D158;
            --font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --main-border-radius: 16px; --button-border-radius: 12px;
            --soft-shadow: 0px 6px 20px rgba(0, 0, 0, 0.25);
            --case-grad-default: linear-gradient(145deg, var(--surface-color), var(--surface-hover-color));
            --roulette-item-height: 80px; /* Height of a single item in the roulette */
            --roulette-visible-items: 3; /* How many items are roughly visible */
            --single-roulette-row-visual-height: calc(var(--roulette-item-height) * var(--roulette-visible-items) + 20px); /* Total height for one reel to show N items + padding */
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { -webkit-overflow-scrolling: touch; }
        body { font-family: var(--font-family); background: linear-gradient(160deg, var(--bg-gradient-start) 0%, var(--bg-gradient-mid) 50%, var(--bg-gradient-end) 100%); color: var(--text-primary); overflow-x: hidden; display: flex; flex-direction: column; min-height: 100vh; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; -webkit-tap-highlight-color: transparent; font-weight: 500; font-size: 15px; line-height: 1.45; }
        #app-container { display: flex; flex-direction: column; flex-grow: 1; }
        #app-header { padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; background: linear-gradient(to right, rgba(30, 33, 50, 0.88), rgba(40, 43, 60, 0.92)); backdrop-filter: blur(18px) saturate(180%); -webkit-backdrop-filter: blur(18px) saturate(180%); border-bottom: 1px solid var(--border-color); box-shadow: 0 2px 12px rgba(0,0,0,0.2); }
        #app-header .app-title-container { display: flex; align-items: center; gap: 8px; }
        #app-header .app-logo { width: 32px; height: 32px; border-radius: 6px; }
        #app-header .app-title { font-size: 1.5em; font-weight: 700; color: var(--text-primary); letter-spacing: -0.5px; flex-shrink: 0; margin-right: 10px; }
        #app-header .wallet-info { display: flex; align-items: center; gap: 8px; flex-shrink: 1; min-width: 0; }
        #ton-connect-button { display: inline-block; flex-shrink: 0; }
        #wallet-address-display, #balance { background-color: var(--surface-hover-color); padding: 8px 12px; border-radius: var(--button-border-radius); font-size: 0.875em; font-weight: 600; border: 1px solid var(--border-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; display: none; transition: background-color 0.2s; }
        #wallet-address-display:hover, #balance:hover { background-color: var(--surface-color); }
        #wallet-address-display.connected, #balance.connected { display: block; }
        #balance.connected { display: flex; align-items: center; }
        #ton-connect-button.connected { display: none; }
        #app-content { flex-grow: 1; padding: 24px 18px; overflow-y: auto; padding-bottom: 80px; }
        .page { display: none; } .page.active { display: block; animation: pageFadeInMinimal 0.3s ease-out; }
        @keyframes pageFadeInMinimal { from { opacity: 0; transform: translateY(8px);} to { opacity: 1; transform: translateY(0px);} }
        #app-nav { display: flex; justify-content: space-around; align-items: stretch; background-color: rgba(28, 28, 30, 0.95); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); border-top: 1px solid var(--border-color); padding: 0; position: sticky; bottom: 0; z-index: 1000; min-height: 65px; box-shadow: 0 -3px 15px rgba(0,0,0,0.15); }
        .nav-button { background: none; border: none; color: var(--text-secondary); display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 11px; font-weight: 500; cursor: pointer; padding: 8px 5px; border-radius: 0; transition: color 0.2s, background-color 0.2s, transform 0.1s ease-out; flex: 1; text-align: center; line-height: 1.3; }
        .nav-button:hover { background-color: rgba(255,255,255,0.05); } .nav-button:active { transform: scale(0.96); }
        .nav-button.active { color: var(--primary-color); font-weight: 600; }
        .nav-button svg { width: 28px; height: 28px; margin-bottom: 4px; fill: currentColor; }
        .nav-button.active svg { fill: var(--primary-color); }
        .button { background: linear-gradient(135deg, var(--primary-gradient-start), var(--primary-gradient-end)); color: var(--text-primary); border: none; padding: 14px 24px; border-radius: var(--button-border-radius); font-size: 1.0em; font-weight: 600; cursor: pointer; transition: filter 0.2s ease-out, transform 0.15s ease-out, box-shadow 0.2s ease-out; text-align: center; display: block; width: 100%; box-shadow: 0 3px 8px rgba(0,122,255,0.25); }
        .button:hover { filter: brightness(1.15); box-shadow: 0 4px 12px rgba(0,122,255,0.3); }
        .button:active { transform: scale(0.97); filter: brightness(0.9); box-shadow: 0 2px 5px rgba(0,122,255,0.2); }
        .button:disabled { background: var(--surface-hover-color); color: var(--text-placeholder); cursor: not-allowed; box-shadow: none; filter: grayscale(0.5); }
        .button-secondary { background-color: var(--surface-hover-color); color: var(--text-secondary); border: 1px solid var(--border-color); box-shadow: none; background-image: none; }
        .button-secondary:hover { background-color: var(--surface-color); color: var(--text-primary); border-color: rgba(120,120,128,0.5); }
        .button-secondary:active { background-color: var(--surface-hover-color); filter: brightness(0.9); }
        .button-secondary:disabled { background: var(--surface-color); color: var(--text-placeholder); border-color: var(--border-color); cursor: not-allowed; filter: grayscale(0.3); }
        h2 { margin-top: 0; font-size: 2.0em; font-weight: 700; color: var(--text-primary); padding-bottom: 10px; margin-bottom: 28px; letter-spacing: -0.5px; }
        h3 { font-size: 1.15em; font-weight: 600; color: var(--text-secondary); margin-top: 24px; margin-bottom: 14px; text-transform: uppercase; letter-spacing: 0.8px; }
        .content-card { background-color: var(--surface-color); padding: 20px; border-radius: var(--main-border-radius); margin-bottom: 20px; border: 1px solid var(--border-color); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .cases-grid, .slots-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(max(150px, calc(50% - 10px - 1px)), 1fr)); gap: 20px; }
        
        .case-card { background-image: var(--case-grad-default); border-radius: var(--main-border-radius); text-align: center; cursor: pointer; transition: all 0.2s ease; border: 1px solid var(--border-color); overflow: hidden; position: relative; display: flex; flex-direction: column; padding: 0; }
        .case-card:hover { filter: brightness(1.12); transform: translateY(-6px) scale(1.02); box-shadow: var(--soft-shadow); }
        .case-image-display { width: 100%; height: 0; padding-bottom: 100%; position: relative; background-color: var(--surface-hover-color); display:flex; align-items:center; justify-content:center; }
        .case-image-display img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; display: block; }
        .case-image-display .overlay-image { position: absolute; width: 70%; height: 70%; top: 50%; left: 50%; transform: translate(-50%, -50%); object-fit: contain; pointer-events: none; filter: drop-shadow(0 3px 5px rgba(0,0,0,0.35)); }
        .case-name { font-weight: 600; font-size: 1.05em; margin-bottom: 8px; color: var(--text-primary); min-height: 2.5em; display: flex; align-items: center; justify-content: center; }
        .case-card .case-name { display: none !important; }
        .case-price { font-size: 0.95em; font-weight: 600; color: var(--text-primary); padding: 12px 0; background-color: rgba(0,0,0,0.2); width: 100%; border-top: 1px solid var(--border-color); }
        
        .slot-card { background-image: var(--case-grad-default); border-radius: var(--main-border-radius); padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s ease; border: 1px solid var(--border-color); overflow: hidden; position: relative; }
        .slot-card:hover { filter: brightness(1.12); transform: translateY(-6px) scale(1.02); box-shadow: var(--soft-shadow); }
        .slot-image-display { width: 85px; height: 85px; margin: 0 auto 18px auto; background-color: transparent; border-radius: var(--button-border-radius); overflow: hidden; position: relative; display:flex; align-items:center; justify-content:center;}
        .slot-image-display img { display: block; width: 100%; height: 100%; object-fit: contain; }
        .slot-name { font-weight: 600; font-size: 1.05em; margin-bottom: 8px; color: var(--text-primary); min-height: 2.5em; display: flex; align-items: center; justify-content: center; }
        .slot-price { font-size: 0.9em; font-weight: 500; color: var(--text-price-color); }
        #profile-balance-display { font-size: 1.6em; font-weight: 600; color: var(--primary-color); margin-bottom: 20px; }
        
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(10, 10, 20, 0.75); backdrop-filter: blur(12px) saturate(150%); -webkit-backdrop-filter: blur(12px) saturate(150%); overflow-y: auto; align-items: flex-start; justify-content: center; padding-top: 5vh; padding-bottom: 5vh; }
        .modal.active { display: flex; animation: modalFadeInMinimal 0.3s ease-out; }
        .modal-content { background-color: var(--surface-color); padding: 28px; border-radius: var(--main-border-radius); width: 100%; max-width: 420px; text-align: center; box-shadow: 0 15px 40px rgba(0,0,0,0.4); border: 1px solid var(--border-color); display: flex; flex-direction: column; margin: auto; }
        .modal-content h3 { margin-top: 0; margin-bottom: 20px; font-size: 1.4em; font-weight: 700; color: var(--text-primary); flex-shrink: 0; }
        .modal-actions { margin-bottom: 18px; display: flex; flex-direction: column; gap: 14px; flex-shrink: 0; }
        .modal-body { overflow-y: auto; flex-grow: 1; -webkit-overflow-scrolling: touch; margin-top: 12px; max-height: 60vh; }
        
        #roulette-wheel-container { width: 100%; flex-shrink: 0; height: var(--single-roulette-row-visual-height); display: flex; gap: 8px; align-items: center; background-color: var(--surface-color); border: 1px solid var(--border-color); border-radius: var(--main-border-radius); overflow: hidden; position: relative; padding: 10px; }
        .roulette-individual-reel-row-visual { flex: 1; height: 100%; overflow: hidden; position: relative; background-color: var(--surface-hover-color); border-radius: var(--button-border-radius); border: 1px solid rgba(255,255,255,0.05); display: none; }
        .roulette-individual-reel-row-visual.active { display: block; }
        .roulette-individual-reel-row-visual::before { content: ''; position: absolute; left: 0; right: 0; top: 50%; height: 3px; background-color: var(--primary-color); opacity: 0.9; transform: translateY(-50%); z-index: 2; pointer-events: none; border-radius: 2px; }
        .roulette-spinner-reel { display: flex; flex-direction: column; position: absolute; left: 0; width: 100%; top: 0; }
        .roulette-item { height: var(--roulette-item-height); display: flex; align-items: center; justify-content: center; padding: 0 5px; box-sizing: border-box; overflow: hidden; transition: opacity 0.3s; }
        .roulette-item img { max-width: 90%; max-height: calc(var(--roulette-item-height) - 10px); object-fit: contain; }
        .case-multiplier-selector { display: flex; justify-content: center; gap: 10px; margin-top: 25px; margin-bottom: 15px; }
        .case-multiplier-selector button { width: auto; flex-grow: 1; padding: 10px 15px; font-size: 0.9em; }
        
        #win-overlay-modal .modal-content, #upgrade-result-modal .modal-content { max-width: 360px; }
        #win-overlay-prize-image, #upgrade-result-image-container { width: 100%; min-height: 80px; margin: 0 auto 20px; border-radius: var(--main-border-radius); background-color: var(--surface-hover-color); display:flex; align-items:center; justify-content:center; overflow:hidden; flex-wrap: wrap; gap: 10px; padding: 10px; }
        #win-overlay-prize-image img, #upgrade-result-image-container img { max-width:70px; max-height:70px; object-fit:contain; border-radius: 8px; background-color: var(--surface-color); padding: 5px; border: 1px solid var(--border-color); }
        #win-overlay-prize-name, #upgrade-result-title { font-size: 1.5em; font-weight: 700; margin-bottom: 8px; }
        #win-overlay-prize-name { color: var(--success-color); } /* Only for win overlay */
        #win-overlay-prize-details, #upgrade-result-message { font-size: 0.9em; color: var(--text-secondary); margin-bottom: 25px; max-height: 60px; overflow-y: auto; text-align: left; padding-left: 10px;}
        .win-overlay-actions button { margin-bottom: 10px; }
        
        #possible-prizes-display { padding-right: 0px; display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 12px; flex-shrink: 0; margin-top: 12px; }
        .prize-card { background-color: var(--surface-hover-color); border-radius: var(--button-border-radius); padding: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; border: 1px solid var(--border-color); text-align: center; min-height: 110px; }
        .prize-card-image-placeholder { width: 55px; height: 55px; background-color: transparent; border-radius: 8px; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }
        .prize-card-image-placeholder img { display: block; width: 100%; height: 100%; object-fit: contain; position: relative; z-index: 1; }
        .prize-card-name { font-size: 0.8em; font-weight: 500; color: var(--text-secondary); line-height: 1.25; width: 100%; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; white-space: normal; }
        .prize-card-price { position: absolute; top: 5px; right: 5px; background-color: var(--primary-color); color: var(--text-primary); font-size: 0.7em; font-weight: 600; padding: 2px 5px; border-radius: 5px; line-height: 1; }
        #roulette-modal hr { border: none; border-top: 1px solid var(--border-color); margin: 18px 0; flex-shrink: 0; }
        #roulette-modal h4 { font-size: 0.95em; color: var(--text-secondary); margin-bottom: 12px; font-weight: 500; flex-shrink: 0; }
        
        #slot-machine-modal .modal-content { max-width: 480px; }
        /* ... (existing slot styles, keep if slots feature is still there) ... */
        
        #withdraw-modal .modal-step { display: none; } #withdraw-modal .modal-step.active { display: block; } #withdraw-modal p { color: var(--text-secondary); margin-bottom: 18px; line-height: 1.55;} #withdraw-modal strong { color: var(--text-primary); font-weight: 600; } #withdraw-modal a.button { margin-bottom: 12px; text-decoration: none; }
        .loader { border: 4px solid var(--surface-hover-color); border-top: 4px solid var(--primary-color); border-radius: 50%; width: 45px; height: 45px; animation: spin 1s linear infinite; margin: 22px auto; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        input[type="text"], input[type="number"], select { width: 100%; padding: 13px 15px; margin-bottom: 14px; border-radius: var(--button-border-radius); background-color: var(--surface-hover-color); color: var(--text-primary); border: 1px solid var(--border-color); font-size: 1em; font-weight: 500; box-sizing: border-box; transition: border-color 0.2s, box-shadow 0.2s; } input[type="text"]::placeholder, input[type="number"]::placeholder { color: var(--text-placeholder); } input[type="text"]:focus, input[type="number"]:focus, select:focus { outline: none; border-color: var(--border-highlight); box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.25); }
        .profile-header { text-align: center; margin-bottom: 28px; padding-top: 12px;} .profile-avatar-placeholder { width: 88px; height: 88px; border-radius: 50%; background-color: var(--surface-hover-color); display: flex; align-items: center; justify-content: center; font-size: 2.8em; font-weight: 600; color: var(--text-secondary); margin: 0 auto 14px auto; border: 3px solid var(--border-color); box-shadow: 0 2px 6px rgba(0,0,0,0.1); } .profile-info .username { font-size: 1.5em; font-weight: 600; margin-bottom: 5px;} .profile-info .userid { font-size: 0.9em; color: var(--text-secondary); }
        #profile-wallet-address { display: block; text-align: left; word-break: break-all; margin-bottom: 10px; }
        .inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(115px, 1fr)); gap: 12px; } .inventory-item { background-color: var(--surface-hover-color); border-radius: var(--button-border-radius); padding: 12px; text-align: center; display: flex; flex-direction: column; justify-content: space-between; border: 1px solid var(--border-color); transition: transform 0.2s, box-shadow 0.2s; } .inventory-item:hover { transform: translateY(-3px); box-shadow: 0 3px 10px rgba(0,0,0,0.15); } .inventory-item .item-image-display { width: 65px; height: 65px; margin: 0 auto 10px auto; background-color: transparent; border-radius: 8px; overflow: hidden; display: flex; align-items: center; justify-content: center; position:relative; } .inventory-item .item-image-display img { display: block; width: 100%; height: 100%; object-fit: contain; position:relative; z-index: 1;}
        .inventory-item-name { font-size: 0.88em; font-weight: 500; margin-bottom: 5px; line-height: 1.35; } .inventory-item-value { font-size: 0.78em; color: var(--secondary-color); font-weight: 500; margin-bottom: 10px;} .inventory-item-actions { display: flex; flex-direction: column; gap: 6px; margin-top: auto; } .inventory-item-actions .button { font-size: 0.78em; padding: 6px 9px; margin: 0; width: 100%; }
        #sell-all-button { margin-top: 18px; background-color: var(--danger-color); color: white; background-image: none; box-shadow: 0 3px 8px rgba(255, 59, 48, 0.35); } #sell-all-button:hover { filter: brightness(1.15); background-color: var(--danger-color); box-shadow: 0 4px 12px rgba(255, 59, 48, 0.4); } #sell-all-button:active { filter: brightness(0.9); transform: scale(0.97); }
        
        /* --- UPGRADE PAGE STYLES --- */
        #upgrade-selection-area { display: flex; justify-content: space-around; align-items: center; margin-bottom: 25px; gap: 10px; }
        .upgrade-item-slot { flex: 1; max-width: calc(50% - 25px); height: 150px; background-color: var(--surface-hover-color); border-radius: var(--main-border-radius); border: 2px dashed var(--border-color); display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: border-color 0.2s, background-color 0.2s; padding: 10px; text-align: center; }
        .upgrade-item-slot:hover { border-color: var(--primary-color); background-color: var(--surface-color); }
        .upgrade-item-slot .slot-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-placeholder); }
        .upgrade-item-slot .slot-placeholder .plus-icon { width: 40px; height: 40px; margin-bottom: 8px; fill: var(--text-placeholder); }
        .upgrade-item-slot .slot-placeholder span { font-size: 0.9em; font-weight: 500; }
        .upgrade-item-slot .slot-item-display img { width: 60px; height: 60px; object-fit: contain; margin-bottom: 8px; border-radius: 8px; }
        .upgrade-item-slot .slot-item-display .slot-item-name { font-size: 0.85em; font-weight: 500; color: var(--text-primary); line-height: 1.2; margin-bottom: 4px; max-height: 2.4em; overflow: hidden; text-overflow: ellipsis; }
        .upgrade-item-slot .slot-item-display .slot-item-value { font-size: 0.75em; font-weight: 600; color: var(--secondary-color); }
        .upgrade-arrow-connector { width: 30px; display: flex; align-items: center; justify-content: center; }
        .upgrade-arrow-connector svg { width: 28px; height: 28px; fill: var(--text-secondary); }
        #upgrade-picker-container { margin-top: 20px; padding: 15px; background-color: rgba(0,0,0,0.1); border-radius: var(--button-border-radius); }
        #upgrade-picker-container h4 { color: var(--text-primary); font-size: 1.1em; margin-bottom: 15px; text-align: center; }
        #upgrade-items-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; padding-right: 5px; }
        #upgrade-items-grid .inventory-item { padding: 10px; min-height: 130px; }
        #upgrade-items-grid .inventory-item .item-image-display { width: 50px; height: 50px; margin-bottom: 8px; }
        #upgrade-items-grid .inventory-item .inventory-item-name { font-size: 0.8em; }
        #upgrade-items-grid .inventory-item .inventory-item-value { font-size: 0.7em; margin-bottom: 8px; }
        #upgrade-items-grid .inventory-item .button { font-size: 0.75em; padding: 5px 8px;}
        #upgrade-chance-display-container { position: relative; width: 150px; height: 150px; margin: 30px auto; display: flex; align-items: center; justify-content: center; }
        #upgrade-chance-circle { width: 100%; height: 100%; border-radius: 50%; border: 8px solid var(--surface-hover-color); position: relative; background: conic-gradient( var(--success-color) 0deg var(--upgrade-win-segment-angle, 0deg), var(--danger-color) var(--upgrade-win-segment-angle, 0deg) 360deg ); box-shadow: 0 0 20px rgba(0,0,0,0.2), inset 0 0 15px rgba(0,0,0,0.3); transition: transform 0.3s ease-out; }
        #upgrade-chance-pointer { width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 18px solid var(--primary-color); position: absolute; top: -2px; left: 50%; transform: translateX(-50%) rotate(0deg); transform-origin: center calc(75px + 9px); z-index: 2; filter: drop-shadow(0px 2px 3px rgba(0,0,0,0.4)); }
        #upgrade-chance-pointer.spinning { transition: transform 5s cubic-bezier(0.25, 0.1, 0.25, 1); }
        #upgrade-chance-text-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: var(--text-primary); background-color: rgba(40, 43, 61, 0.85); width: calc(100% - 32px); height: calc(100% - 32px); border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px; box-shadow: inset 0 0 10px rgba(0,0,0,0.2); }
        #upgrade-calculated-multiplier { font-size: 2.2em; font-weight: 800; line-height: 1.1; color: var(--primary-gradient-end); display: block; }
        #upgrade-calculated-chance { font-size: 1.1em; font-weight: 600; color: var(--text-secondary); display: block; }
        #multiplier-buttons, #upgrade-inventory-select, #upgrade-page .content-card p:first-of-type, #upgrade-page .content-card #upgrade-result { display: none; }
        
        .stats-box { display: flex; justify-content: space-around; margin: 24px 0; gap: 14px; } .stat-item { background-color: var(--surface-hover-color); padding: 14px; border-radius: var(--button-border-radius); flex: 1; text-align: center; border: 1px solid var(--border-color); } .stat-item .value { font-size: 1.6em; font-weight: 600; color: var(--primary-color); } .stat-item .label { font-size: 0.8em; color: var(--text-secondary); margin-top: 5px; } .invited-users-list div { padding: 10px 0; border-bottom: 1px solid var(--border-color); font-size: 0.9em;} .invited-users-list div:last-child { border-bottom: none; }
        .leaderboard-list { padding-left: 0; padding-right: 0; } .leaderboard-list .leader-entry { display: flex; align-items: center; padding: 16px 20px; border-bottom: 1px solid var(--border-color); transition: background-color 0.25s ease-out; position: relative; } .leaderboard-list .leader-entry:hover { background-color: rgba(255,255,255,0.04); } .leaderboard-list .leader-entry:last-child { border-bottom: none; } .leader-entry .rank { font-weight: 700; font-size: 1.05em; min-width: 40px; text-align: left; color: var(--text-secondary); margin-right: 15px; } .leader-entry .avatar-placeholder { width: 44px; height: 44px; border-radius: 50%; background-color: var(--surface-hover-color); color: var(--text-secondary); display: flex; align-items: center; justify-content: center; font-size: 1.2em; font-weight: 600; margin: 0 16px 0 0; border: 2px solid var(--border-color); } .leader-entry .info { flex-grow: 1; } .leader-entry .info .name { font-weight: 600; font-size: 1.1em; color: var(--text-primary); margin-bottom: 3px; } .leader-entry .info .details { font-size: 0.85em; color: var(--text-secondary); line-height: 1.3; } .leader-entry .score { margin-left: auto; font-weight: 700; font-size: 1.05em; color: var(--primary-color); padding-left: 15px; text-align: right; } .leader-entry.current-user-entry { background-color: rgba(0, 122, 255, 0.12); border-left: 3px solid var(--primary-color); padding-left: 17px;} .leader-entry.current-user-entry .rank { color: var(--primary-color); } .leader-entry.current-user-entry .info .name { color: var(--primary-gradient-end); font-weight: 700; } .leader-entry.current-user-entry .score { color: var(--secondary-color); font-weight: 800; } .leader-entry.current-user-entry .avatar-placeholder { border-color: var(--primary-color); }
        .promocode-input-group { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; } .promocode-input-group input { flex-grow: 1; margin-bottom: 0; } .promocode-input-group button { flex-shrink: 0; padding: 13px 18px; width: auto; }
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(160deg, var(--bg-gradient-start) 0%, var(--bg-gradient-mid) 50%, var(--bg-gradient-end) 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; color: var(--text-primary); font-family: var(--font-family); transition: opacity 0.5s ease-out, visibility 0.5s ease-out; }
        #loading-screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .loading-logo { width: 80px; height: 80px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .loading-title { font-size: 2.8em; font-weight: 800; margin-bottom: 30px; letter-spacing: -1px; background: linear-gradient(45deg, var(--primary-color), var(--primary-gradient-end)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 2px 8px rgba(0,122,255,0.2); }
        #loading-screen .loader { width: 60px; height: 60px; margin-top: 20px; margin-bottom: 30px; border-width: 6px; box-shadow: 0 0 15px rgba(0,122,255,0.2); }
        .loading-status-text { font-size: 1.1em; font-weight: 500; color: var(--text-secondary); margin-bottom: 40px; }
        .channel-link-container { position: absolute; bottom: 30px; width: 100%; text-align: center; }
        .channel-link-container a { color: var(--primary-color); text-decoration: none; font-weight: 600; font-size: 1.1em; padding: 8px 15px; border-radius: 8px; background-color: rgba(0,122,255,0.1); transition: background-color 0.2s, color 0.2s; }
        .channel-link-container a:hover { background-color: rgba(0,122,255,0.2); color: var(--text-primary); }
    </style>
</head>
<body>
    <div id="loading-screen">
        <img src="https://i.ibb.co/N6dt5Pc9/Background-Eraser-20250423-210102862.png" alt="Ludik Gifts Logo" class="loading-logo">
        <div class="loading-title">Ludik Gifts</div>
        <div class="loader"></div>
        <p id="loading-status" class="loading-status-text">Loading...</p>
        <div class="channel-link-container">
            <a href="https://t.me/upgradeDemoBot" target="_blank">@upgradeDemoBot</a>
        </div>
    </div>
    <div id="app-container">
        <header id="app-header">
            <div class="app-title-container"><img src="https://i.ibb.co/N6dt5Pc9/Background-Eraser-20250423-210102862.png" alt="Ludik Gifts Logo" class="app-logo"><div class="app-title">Ludik Gifts</div></div>
            <div class="wallet-info"><div id="wallet-address-display">Connected: ...</div><div id="balance"><span id="ton-balance">0.00</span> TON</div><div id="ton-connect-button"></div></div>
        </header>

        <main id="app-content">
            <div id="main-page" class="page active">
                <h2>Cases</h2>
                <div id="cases-grid" class="cases-grid"></div>
            </div>

            <div id="upgrade-page" class="page">
                <h2>Upgrade Item</h2>
                <div class="content-card">
                    <div id="upgrade-selection-area">
                        <div class="upgrade-item-slot" id="selected-inventory-item-slot" data-type="inventory">
                            <div class="slot-placeholder">
                                <svg class="plus-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" /></svg>
                                <span>Your Item</span>
                            </div>
                            <div class="slot-item-display" style="display: none;">
                                <img src="" alt="Selected Item">
                                <p class="slot-item-name">Item Name</p>
                                <p class="slot-item-value">0.00 TON</p>
                            </div>
                        </div>
                        <div class="upgrade-arrow-connector">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M4,15V9H12V4.16L19.84,12L12,19.84V15H4Z" /></svg>
                        </div>
                        <div class="upgrade-item-slot" id="desired-upgrade-item-slot" data-type="desired">
                            <div class="slot-placeholder">
                                <svg class="plus-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" /></svg>
                                <span>Desired Item</span>
                            </div>
                            <div class="slot-item-display" style="display: none;">
                                <img src="" alt="Desired Item">
                                <p class="slot-item-name">Item Name</p>
                                <p class="slot-item-value">0.00 TON</p>
                            </div>
                        </div>
                    </div>
                    <div id="upgrade-picker-container" style="display: none;">
                        <h4 id="upgrade-picker-title">Select Your Item</h4>
                        <div id="upgrade-items-grid" class="inventory-grid" style="max-height: 250px; overflow-y: auto; margin-bottom: 15px;"></div>
                        <button id="close-upgrade-picker-button" class="button button-secondary">Close Picker</button>
                    </div>
                    <div id="upgrade-chance-display-container">
                        <div id="upgrade-chance-circle">
                            <div id="upgrade-chance-pointer"></div>
                        </div>
                        <div id="upgrade-chance-text-overlay">
                            <span id="upgrade-calculated-multiplier">--x</span>
                            <span id="upgrade-calculated-chance">--%</span>
                        </div>
                    </div>
                    <button id="do-upgrade-button" class="button" disabled>Select Items to Upgrade</button>
                </div>
            </div>

            <div id="invite-page" class="page"><h2>Referrals</h2><div class="content-card"><p>Invite friends & earn <strong>10%</strong> of their deposits!</p><input type="text" id="referral-link" value="Loading..." readonly><button id="copy-ref-link-button" class="button">Copy Link</button><div class="stats-box"><div class="stat-item"><div id="referral-balance" class="value">0.00 TON</div><div class="label">Earnings</div></div><div class="stat-item"><div id="invited-count" class="value">0</div><div class="label">Invited</div></div></div><button id="withdraw-referral-button" class="button button-secondary">Withdraw</button></div><div class="content-card"><h3>Invited Friends</h3><div id="invited-users-list-display" class="invited-users-list"><p>No friends invited yet.</p></div></div></div>
            <div id="leaderboard-page" class="page"><h2>Leaderboard</h2><div id="leaderboard-list" class="leaderboard-list content-card" style="padding-top:0; padding-bottom:0;"></div></div>
            
            <div id="profile-page" class="page">
                <div class="profile-header">
                    <div id="profile-avatar" class="profile-avatar-placeholder"></div>
                    <div class="profile-info">
                        <div id="profile-username" class="username">User</div>
                        <div id="profile-userid" class="userid">#...</div>
                    </div>
                </div>
                <div class="content-card">
                    <h3>Balance</h3>
                    <div id="profile-balance-display">0.00 TON</div>
                    <input type="number" id="topup-amount-input" placeholder="Amount in TON (e.g., 10)">
                    <button id="instant-topup-button" class="button">Top Up Balance</button>
                </div>
                <div class="content-card"><h3>Promocode</h3><div class="promocode-input-group"><input type="text" id="promocode-input" placeholder="Enter code"><button id="redeem-promocode-button" class="button button-secondary">Redeem</button></div></div>
                <div class="content-card"><h3>Wallet</h3><div id="profile-wallet-address">Not Connected</div><button id="disconnect-wallet-button" class="button button-secondary" style="display: none;">Disconnect</button></div>
                <div class="content-card"><h3>My Collection (<span id="inventory-count">0</span>)</h3><div id="inventory-grid" class="inventory-grid"><p id="empty-inventory-message" style="grid-column: 1 / -1; text-align: center; color: var(--text-placeholder); padding:15px 0;">Your collection is empty.</p></div><button id="sell-all-button" class="button" style="display: none;">Sell All for <span id="sell-all-value">0.00</span> TON</button></div>
            </div>
        </main>

        <nav id="app-nav">
            <button class="nav-button active" data-page="main-page"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>Games</button>
            <button class="nav-button" data-page="upgrade-page"><svg viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/><path d="M7.41 11.41L12 6.83l4.59 4.58L18 10l-6-6-6 6z"/><path d="M7.41 7.41L12 2.83l4.59 4.58L18 6l-6-6-6 6z"/></svg>Upgrade</button>
            <button class="nav-button" data-page="invite-page"><svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>Referrals</button>
            <button class="nav-button" data-page="leaderboard-page"><svg viewBox="0 0 24 24"><path d="M16,1H4C2.89,1 2,1.89 2,3V17H4V3H16V1M16.5,5H7.5C6.67,5 6,5.67 6,6.5V22.5L12,19.5L18,22.5V6.5C18,5.67 17.33,5 16.5,5M14,11H10V9H14V11M14,15H10V13H14V15Z"/></svg>Leaders</button>
            <button class="nav-button" data-page="profile-page"><svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>Profile</button>
        </nav>
    </div>

    <div id="roulette-modal" class="modal">
        <div class="modal-content">
            <h3 id="roulette-case-name">Opening Case...</h3>
            <div id="roulette-wheel-container">
                <div class="roulette-individual-reel-row-visual" id="roulette-reel-1"><div class="roulette-spinner-reel"></div></div>
                <div class="roulette-individual-reel-row-visual" id="roulette-reel-2"><div class="roulette-spinner-reel"></div></div>
                <div class="roulette-individual-reel-row-visual" id="roulette-reel-3"><div class="roulette-spinner-reel"></div></div>
            </div>
            <div class="case-multiplier-selector">
                <button class="button button-secondary active-multiplier" data-multiplier="1">1x</button>
                <button class="button button-secondary" data-multiplier="2">2x</button>
                <button class="button button-secondary" data-multiplier="3">3x</button>
            </div>
            <div class="modal-actions">
                <button id="spin-button" class="button">Spin</button>
                <button id="close-roulette-button" class="button button-secondary">Close</button>
            </div>
            <hr><h4>Possible Prizes:</h4><div id="possible-prizes-display"></div>
        </div>
    </div>

    <div id="win-overlay-modal" class="modal">
        <div class="modal-content">
            <div id="win-overlay-prize-image"></div>
            <div id="win-overlay-prize-name">You Won: Item!</div>
            <div id="win-overlay-prize-details"></div>
            <div class="win-overlay-actions modal-actions">
                <button id="win-overlay-save-button" class="button">Save to Collection</button>
                <button id="win-overlay-convert-button" class="button button-secondary">Convert All to <span id="win-overlay-convert-value">0.00</span> TON</button>
            </div>
        </div>
    </div>
    
    <div id="upgrade-result-modal" class="modal">
        <div class="modal-content">
            <div id="upgrade-result-image-container"></div>
            <h3 id="upgrade-result-title">Upgrade Status</h3>
            <p id="upgrade-result-message">Details...</p>
            <div class="modal-actions">
                <button id="close-upgrade-result-modal-button" class="button">OK</button>
            </div>
        </div>
    </div>

    <div id="withdraw-modal" class="modal">
        <div class="modal-content">
            <h3>Withdraw Gift</h3>
            <div class="modal-body">
                <p>To withdraw your gift, you must first interact with our partner bot.
                    <br><br><strong>IMPORTANT:</strong>
                    <br>1. Open the bot via the button below.
                    <br>2. You <strong>MUST</strong> send any message to the <a href="https://t.me/upgradeDemoBot" target="_blank" style="color: var(--primary-color); text-decoration: underline;">@upgradeDemoBot</a>. Otherwise, the gift cannot be delivered.
                </p>
                <a href="https://t.me/upgradeDemoBot" target="_blank" class="button" style="margin-bottom: 10px;">Open @upgradeDemoBot</a>
                <p id="withdraw-status-message"></p>
                <div id="withdraw-finalizing-loader" class="loader" style="display:none;"></div>
            </div>
            <button id="close-withdraw-modal-button" class="button button-secondary" style="margin-top:15px;">Close</button>
        </div>
    </div>

<script>
// --- Global Constants and State ---
const API_BASE_URL = 'https://ludik.onrender.com';
const BOT_USERNAME = 'upgradeDemoBot';
const TON_COIN_FULL_URL = 'https://case-bot.com/images/actions/ton.svg';

const currentUser = {
    id: null, username: null, first_name: 'User', last_name: null,
    walletAddress: null, walletAddressRaw: null, tonBalance: 0.00,
    inventory: [], referralCode: null, referralEarningsPending: 0,
    invited_friends_count: 0, photo_url: null
};

let currentOpenCaseOrSlot = null;
let selectedCaseMultiplier = 1;
let itemToWithdraw = null;
let lastWonPrizesForOverlay = [];
let selectedItemForUpgrade = null;
let desiredItemForUpgrade = null;
let calculatedUpgradeMultiplier = 0;
let calculatedUpgradeChance = 0;
let currentUpgradePickerType = null;
let allAppGiftsForUpgrade = [];

// --- New Gift Name to ID Mapping ---
const GIFT_NAME_TO_ID_MAP = {
  "Santa Hat": "5983471780763796287","Signet Ring": "5936085638515261992","Precious Peach": "5933671725160989227","Plush Pepe": "5936013938331222567",
  "Spiced Wine": "5913442287462908725","Jelly Bunny": "5915502858152706668","Durov's Cap": "5915521180483191380","Perfume Bottle": "5913517067138499193",
  "Eternal Rose": "5882125812596999035","Berry Box": "5882252952218894938","Vintage Cigar": "5857140566201991735","Magic Potion": "5846226946928673709",
  "Kissed Frog": "5845776576658015084","Hex Pot": "5825801628657124140","Evil Eye": "5825480571261813595","Sharp Tongue": "5841689550203650524",
  "Trapped Heart": "5841391256135008713","Skull Flower": "5839038009193792264","Scared Cat": "5837059369300132790","Spy Agaric": "5821261908354794038",
  "Homemade Cake": "5783075783622787539","Genie Lamp": "5933531623327795414","Lunar Snake": "6028426950047957932","Party Sparkler": "6003643167683903930",
  "Jester Hat": "5933590374185435592","Witch Hat": "5821384757304362229","Hanging Star": "5915733223018594841","Love Candle": "5915550639663874519",
  "Cookie Heart": "6001538689543439169","Desk Calendar": "5782988952268964995","Jingle Bells": "6001473264306619020","Snow Mittens": "5980789805615678057",
  "Voodoo Doll": "5836780359634649414","Mad Pumpkin": "5841632504448025405","Hypno Lollipop": "5825895989088617224","B-Day Candle": "5782984811920491178",
  "Bunny Muffin": "5935936766358847989","Astral Shard": "5933629604416717361","Flying Broom": "5837063436634161765","Crystal Ball": "5841336413697606412",
  "Eternal Candle": "5821205665758053411","Swiss Watch": "5936043693864651359","Ginger Cookie": "5983484377902875708","Mini Oscar": "5879737836550226478",
  "Lol Pop": "5170594532177215681","Ion Gem": "5843762284240831056","Star Notepad": "5936017773737018241","Loot Bag": "5868659926187901653",
  "Love Potion": "5868348541058942091","Toy Bear": "5868220813026526561","Diamond Ring": "5868503709637411929","Sakura Flower": "5167939598143193218",
  "Sleigh Bell": "5981026247860290310","Top Hat": "5897593557492957738","Record Player": "5856973938650776169","Winter Wreath": "5983259145522906006",
  "Snow Globe": "5981132629905245483","Electric Skull": "5846192273657692751","Tama Gadget": "6023752243218481939","Candy Cane": "6003373314888696650",
  "Neko Helmet": "5933793770951673155","Jack-in-the-Box": "6005659564635063386","Easter Egg": "5773668482394620318",
  "Bonded Ring": "5870661333703197240", "Pet Snake": "6023917088358269866", "Snake Box": "6023679164349940429",
  "Xmas Stocking": "6003767644426076664", "Big Year": "6028283532500009446", "Gem Signet": "5859442703032386168",
  "Light Sword": "5897581235231785485", "Restless Jar": "5870784783948186838", "Nail Bracelet": "5870720080265871962",
  "Heroic Helmet": "5895328365971244193", "Bow Tie": "5895544372761461960", "Heart Locket": "5868455043362980631",
  "Lush Bouquet": "5871002671934079382", "Whip Cupcake": "5933543975653737112", "Joyful Bundle": "5870862540036113469",
  "Cupid Charm": "5868561433997870501", "Valentine Box": "5868595669182186720", "Snoop Dogg": "6014591077976114307",
  "Swag Bag": "6012607142387778152", "Snoop Cigar": "6012435906336654262", "Low Rider": "6014675319464657779",
  "Westside Sign": "6014697240977737490"
};

// --- DOM Element References ---
const headerElements = { tonConnectButton: document.getElementById('ton-connect-button'), walletAddressDisplay: document.getElementById('wallet-address-display'), tonBalanceSpan: document.getElementById('ton-balance'), balanceDisplay: document.getElementById('balance') };
const appNavButtons = document.querySelectorAll('.nav-button');
const pages = document.querySelectorAll('.page');
const casesGrid = document.getElementById('cases-grid');
const loadingScreen = document.getElementById('loading-screen');
const loadingStatusText = document.getElementById('loading-status');
const rouletteModal = document.getElementById('roulette-modal');
const rouletteCaseName = document.getElementById('roulette-case-name');
const spinButton = document.getElementById('spin-button');
const closeRouletteButton = document.getElementById('close-roulette-button');
const possiblePrizesDisplay = document.getElementById('possible-prizes-display');
const caseMultiplierSelector = document.querySelector('.case-multiplier-selector');
const rouletteReel1 = document.getElementById('roulette-reel-1');
const rouletteReel2 = document.getElementById('roulette-reel-2');
const rouletteReel3 = document.getElementById('roulette-reel-3');
const winOverlayModal = document.getElementById('win-overlay-modal');
const winOverlayPrizeImageContainer = document.getElementById('win-overlay-prize-image');
const winOverlayNameEl = document.getElementById('win-overlay-prize-name');
const winOverlayPrizeDetailsEl = document.getElementById('win-overlay-prize-details');
const winOverlaySaveBtn = document.getElementById('win-overlay-save-button');
const winOverlayConvertBtn = document.getElementById('win-overlay-convert-button');
const winOverlayConvertValue = document.getElementById('win-overlay-convert-value');
const withdrawModal = document.getElementById('withdraw-modal');
const withdrawStatusMessage = document.getElementById('withdraw-status-message');
const closeWithdrawModalButton = document.getElementById('close-withdraw-modal-button');
const withdrawFinalizingLoader = document.getElementById('withdraw-finalizing-loader');
const profileElements = { avatar: document.getElementById('profile-avatar'), username: document.getElementById('profile-username'), userid: document.getElementById('profile-userid'), balanceDisplay: document.getElementById('profile-balance-display'), walletAddress: document.getElementById('profile-wallet-address'), inventoryGrid: document.getElementById('inventory-grid'), inventoryCount: document.getElementById('inventory-count'), emptyInventoryMessage: document.getElementById('empty-inventory-message'), disconnectWalletButton: document.getElementById('disconnect-wallet-button'), topupAmountInput: document.getElementById('topup-amount-input'), instantTopupButton: document.getElementById('instant-topup-button'), sellAllButton: document.getElementById('sell-all-button'), sellAllValueSpan: document.getElementById('sell-all-value'), promocodeInput: document.getElementById('promocode-input'), redeemPromocodeButton: document.getElementById('redeem-promocode-button') };
const upgradePageElements = { selectedInventoryItemSlot: document.getElementById('selected-inventory-item-slot'), desiredUpgradeItemSlot: document.getElementById('desired-upgrade-item-slot'), upgradePickerContainer: document.getElementById('upgrade-picker-container'), upgradePickerTitle: document.getElementById('upgrade-picker-title'), upgradeItemsGrid: document.getElementById('upgrade-items-grid'), closeUpgradePickerButton: document.getElementById('close-upgrade-picker-button'), chanceCircle: document.getElementById('upgrade-chance-circle'), chancePointer: document.getElementById('upgrade-chance-pointer'), calculatedMultiplierText: document.getElementById('upgrade-calculated-multiplier'), calculatedChanceText: document.getElementById('upgrade-calculated-chance'), doUpgradeButton: document.getElementById('do-upgrade-button'), upgradeResultModal: document.getElementById('upgrade-result-modal'), upgradeResultImageContainer: document.getElementById('upgrade-result-image-container'), upgradeResultTitle: document.getElementById('upgrade-result-title'), upgradeResultMessage: document.getElementById('upgrade-result-message'), closeUpgradeResultModalButton: document.getElementById('close-upgrade-result-modal-button') };
const inviteElements = { referralLink: document.getElementById('referral-link'), copyRefLinkButton: document.getElementById('copy-ref-link-button'), referralBalance: document.getElementById('referral-balance'), invitedCount: document.getElementById('invited-count'), withdrawReferralButton: document.getElementById('withdraw-referral-button'), invitedUsersListDisplay: document.getElementById('invited-users-list-display') };
const leaderboardList = document.getElementById('leaderboard-list');

const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({ manifestUrl: 'https://raw.githubusercontent.com/Vasiliy-katsyka/case/main/tonconnect-manifest.json', buttonRootId: 'ton-connect-button' });

// --- Image Generation Logic ---
function generateImageFilename(nameOrUrl) {
    if (!nameOrUrl) return '';
    if (nameOrUrl.startsWith('http')) return nameOrUrl;
    if (nameOrUrl.toLowerCase().includes("ton") && nameOrUrl.toLowerCase().includes("prize")) return TON_COIN_FULL_URL;
    if (GIFT_NAME_TO_ID_MAP[nameOrUrl]) return `https://cdn.changes.tg/gifts/originals/${GIFT_NAME_TO_ID_MAP[nameOrUrl]}/Original.png`;
    // Fallback for non-CDN items from cases data
    const caseItem = casesData.flatMap(c => c.prizes).find(p => p.name === nameOrUrl);
    if (caseItem && caseItem.imageFilename) return caseItem.imageFilename;
    return ''; // Default empty if not found
}

// --- Hardcoded Game Data (Cases) ---
const casesData = [
    {'id':'all_in_01','name':'All In','priceTON':0.1,'prizes': [{'name':'Plush Pepe'},{'name':'Durov\'s Cap'},{'name':'Precious Peach'},{'name':'Heart Locket'},{'name':'Heroic Helmet'},{'name':'Bonded Ring'},{'name':'Lol Pop'},{'name':'Baggin\' Cat','imageFilename': 'https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/refs/heads/main/IMG_20250718_234950_164.png'},{'name':'Nothing','imageFilename': 'placeholder_nothing.png'}]},
    {'id':'small_billionaire_05','name':'Small Billionaire','priceTON':0.5,'prizes': [{'name':'Perfume Bottle'},{'name':'Vintage Cigar'},{'name':'Signet Ring'},{'name':'Swiss Watch'},{'name':'Nail Bracelet'},{'name':'Low Rider'},{'name':'Skebob','imageFilename':'https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/refs/heads/main/BackgroundEraser_20250718_034626591.png'},{'name':'Snake Box'},{'name':'Nothing','imageFilename': 'placeholder_nothing.png'}]},
    {'id':'dildo_case','name':'Dildo Case','priceTON':5.0,'prizes': [{'name':'Dildo','imageFilename':'https://raw.githubusercontent.com/Vasiliy-katsyka/newTacos/main/BackgroundEraser_20250717_003931098.png'},{'name':'Nail Bracelet'},{'name':'Whip Cupcake'},{'name':'Bow Tie'},{'name':'Lush Bouquet'},{'name':'Joyful Bundle'},{'name':'Valentine Box'},{'name':'Cupid Charm'}]},
    {'id': 'snoop_case', 'name': 'Snoop\'s Stash', 'priceTON': 8.0, 'prizes': [{'name': 'Snoop Dogg'},{'name': 'Swag Bag'},{'name': 'Snoop Cigar'},{'name': 'Low Rider'},{'name': 'Westside Sign'},{'name': 'Heroic Helmet'},{'name':'Baggin\' Cat','imageFilename':'https://raw.githubusercontent.com/Vasiliy-katsyka/BagginCat/refs/heads/main/IMG_20250718_234950_164.png'},{'name':'Skebob','imageFilename':'https://raw.githubusercontent.com/Vasiliy-katsyka/skebobs/refs/heads/main/BackgroundEraser_20250718_034626591.png'},{'name': 'Record Player'}]},
    {'id':'plushpepe','name':'Plush Pepe Hoard','priceTON': 200.0,'prizes': [{'name':'Plush Pepe'},{'name':'Durov\'s Cap'},{'name':'Heart Locket'},{'name':'Heroic Helmet'},{'name':'Precious Peach'},{'name':'Bonded Ring'},{'name':'Astral Shard'}]}
];
// Note: Floor prices will be fetched from the backend or a master list in JS. This just defines case contents.

// --- Core App Logic ---
async function apiRequest(endpoint, method = 'GET', body = null) {
    const headers = { 'Content-Type': 'application/json' };
    if (Telegram.WebApp.initData) headers['X-Telegram-Init-Data'] = Telegram.WebApp.initData;
    const config = { method, headers };
    if (body) config.body = JSON.stringify(body);
    try {
        const response = await fetch(API_BASE_URL + endpoint, config);
        if (!response.ok) {
            const errData = await response.json().catch(() => ({ error: `HTTP ${response.status}` }));
            throw new Error(errData.error || errData.message || 'Request failed');
        }
        return response.status === 204 ? null : await response.json();
    } catch (error) {
        showTGNotification(error.message, 'error');
        throw error;
    }
}

function showTGNotification(message, type = 'info') {
    Telegram.WebApp.showAlert?.(message);
    const haptic = Telegram.WebApp.HapticFeedback;
    if (haptic) {
        if (type === 'success') haptic.notificationOccurred('success');
        else if (type === 'error') haptic.notificationOccurred('error');
        else if (type === 'warning') haptic.notificationOccurred('warning');
    }
}

function updateBalances() {
    const balance = currentUser.tonBalance.toFixed(2);
    headerElements.tonBalanceSpan.textContent = balance;
    profileElements.balanceDisplay.textContent = `${balance} TON`;
}

function navigateToPage(pageId) {
    pages.forEach(p => p.classList.remove('active'));
    document.getElementById(pageId)?.classList.add('active');
    appNavButtons.forEach(b => b.classList.toggle('active', b.dataset.page === pageId));
    if (pageId === 'invite-page') renderInvitedFriendsList();
    window.scrollTo(0, 0);
}

function renderCases() {
    casesGrid.innerHTML = '';
    casesData.forEach(caseItem => {
        const card = document.createElement('div');
        card.className = 'case-card';
        card.onclick = () => openRouletteModal(caseItem);
        const mainPrize = caseItem.prizes[0];
        card.innerHTML = `
            <div class="case-image-display">
                <img src="${generateImageFilename(mainPrize.name)}" alt="${mainPrize.name}" loading="lazy">
            </div>
            <div class="case-price">${parseFloat(caseItem.priceTON).toFixed(1)} TON</div>
        `;
        casesGrid.appendChild(card);
    });
}

function renderProfile() {
    profileElements.avatar.innerHTML = '';
    if (currentUser.photo_url) {
        const img = document.createElement('img');
        img.src = currentUser.photo_url;
        img.style.width = '100%'; img.style.height = '100%';
        img.style.objectFit = 'cover'; img.style.borderRadius = 'inherit';
        profileElements.avatar.appendChild(img);
    } else {
        profileElements.avatar.textContent = currentUser.first_name ? currentUser.first_name.charAt(0).toUpperCase() : '?';
    }
    profileElements.username.textContent = `${currentUser.first_name || ''} ${currentUser.last_name || ''}`.trim() || currentUser.username || 'User';
    profileElements.userid.textContent = currentUser.id ? `#${currentUser.id}` : '#...';
    profileElements.walletAddress.textContent = 'TON Connect is for display only.';
    profileElements.disconnectWalletButton.style.display = 'none'; // Not used in this version
    renderInventory();
}

function renderInventory() {
    profileElements.inventoryGrid.innerHTML = '';
    let totalValue = 0;
    if (currentUser.inventory.length === 0) {
        profileElements.emptyInventoryMessage.style.display = 'block';
        profileElements.sellAllButton.style.display = 'none';
    } else {
        profileElements.emptyInventoryMessage.style.display = 'none';
        currentUser.inventory.forEach(item => {
            totalValue += item.currentValue || 0;
            const itemDiv = document.createElement('div');
            itemDiv.className = 'inventory-item';
            const imgCont = document.createElement('div');
            imgCont.className = 'item-image-display';
            const img = document.createElement('img');
            img.src = generateImageFilename(item.imageFilename || item.name);
            img.alt = item.name;
            img.loading = 'lazy';
            imgCont.appendChild(img);
            itemDiv.innerHTML = `
                <div class="inventory-item-name" title="${item.name}">${item.name}</div>
                <div class="inventory-item-value">${(item.currentValue || 0).toFixed(2)} TON</div>
                <div class="inventory-item-actions">
                    ${item.is_ton_prize ? '<span style="font-size:0.8em; color:var(--success-color);">TON Prize</span>' : `
                        <button class="button button-secondary" onclick="startWithdrawalProcess(${item.id}, '${item.name}')">Withdraw</button>
                        <button class="button button-secondary" onclick="handleSingleConvert(${item.id})">Convert</button>
                    `}
                </div>
            `;
            itemDiv.insertBefore(imgCont, itemDiv.firstChild);
            profileElements.inventoryGrid.appendChild(itemDiv);
        });
        profileElements.sellAllButton.style.display = 'block';
        profileElements.sellAllValueSpan.textContent = totalValue.toFixed(2);
    }
    profileElements.inventoryCount.textContent = currentUser.inventory.length;
}

// --- Event Handlers & Game Logic ---

async function handleInstantTopup() {
    const amountInput = profileElements.topupAmountInput;
    const amount = parseFloat(amountInput.value);
    if (isNaN(amount) || amount <= 0) {
        showTGNotification("Please enter a valid amount to top up.", "warning");
        return;
    }
    profileElements.instantTopupButton.disabled = true;
    profileElements.instantTopupButton.textContent = "Topping Up...";
    try {
        const res = await apiRequest('/api/instant_topup', 'POST', { amount });
        if (res.status === 'success') {
            currentUser.tonBalance = res.new_balance_ton;
            updateBalances();
            showTGNotification(res.message, 'success');
            amountInput.value = '';
        }
    } catch (e) {
        // Error is shown by apiRequest
    } finally {
        profileElements.instantTopupButton.disabled = false;
        profileElements.instantTopupButton.textContent = "Top Up Balance";
    }
}

function startWithdrawalProcess(inventoryItemId, itemName) {
    if (Telegram.WebApp.showConfirm) {
        Telegram.WebApp.showConfirm(`Do you really want to withdraw ${itemName}?`, async (ok) => {
            if (ok) {
                await completeWithdrawal(inventoryItemId, itemName);
            }
        });
    } else if (confirm(`Do you really want to withdraw ${itemName}?`)) {
        completeWithdrawal(inventoryItemId, itemName);
    }
}

async function completeWithdrawal(inventoryItemId, itemName) {
    withdrawModal.classList.add('active');
    withdrawFinalizingLoader.style.display = 'block';
    withdrawStatusMessage.textContent = `Withdrawing your ${itemName}...`;
    try {
        const res = await apiRequest('/api/withdraw_gift', 'POST', { inventory_item_id: inventoryItemId });
        if (res.status === 'success') {
            withdrawStatusMessage.style.color = 'var(--success-color)';
            withdrawStatusMessage.textContent = res.message;
            // Optimistically remove from frontend inventory
            currentUser.inventory = currentUser.inventory.filter(item => item.id !== inventoryItemId);
            renderInventory();
        } else {
            withdrawStatusMessage.style.color = 'var(--danger-color)';
            withdrawStatusMessage.textContent = res.error || 'Withdrawal failed.';
        }
    } catch (e) {
        withdrawStatusMessage.style.color = 'var(--danger-color)';
        withdrawStatusMessage.textContent = 'An error occurred. Please try again.';
    } finally {
        withdrawFinalizingLoader.style.display = 'none';
    }
}

function closeWithdrawModal() {
    withdrawModal.classList.remove('active');
    withdrawStatusMessage.textContent = '';
    withdrawStatusMessage.style.color = 'var(--text-secondary)';
}


// --- All other functions (roulette, upgrade, etc.) remain as they were in the original full code ---
// This includes: openRouletteModal, spinRoulette, handleUpgrade, sellAllItems, etc.
// They are copied here verbatim for completeness.

function openRouletteModal(caseItem) {
    currentOpenCaseOrSlot = caseItem;
    selectedCaseMultiplier = 1;
    updateCaseMultiplierButtons();
    rouletteCaseName.textContent = caseItem.name;
    updateSpinButtonText();

    possiblePrizesDisplay.innerHTML = '';
    caseItem.prizes.forEach(p => {
        if (p.name === 'Nothing') return;
        const card = document.createElement('div');
        card.className = 'prize-card';
        card.innerHTML = `
            <div class="prize-card-image-placeholder"><img src="${generateImageFilename(p.imageFilename || p.name)}" alt="${p.name}"></div>
            <span class="prize-card-name">${p.name}</span>`;
        possiblePrizesDisplay.appendChild(card);
    });
    rouletteModal.classList.add('active');
}

function updateSpinButtonText() {
    if (currentOpenCaseOrSlot) {
        const totalPrice = parseFloat(currentOpenCaseOrSlot.priceTON) * selectedCaseMultiplier;
        spinButton.textContent = `Spin ${selectedCaseMultiplier}x (${totalPrice.toFixed(1)} TON)`;
    }
}

function updateCaseMultiplierButtons() {
    caseMultiplierSelector.querySelectorAll('button').forEach(btn => {
        btn.classList.toggle('active-multiplier', parseInt(btn.dataset.multiplier) === selectedCaseMultiplier);
        if(parseInt(btn.dataset.multiplier) === selectedCaseMultiplier) btn.classList.remove('button-secondary');
        else btn.classList.add('button-secondary');
    });
    initializeRouletteVisuals(currentOpenCaseOrSlot, selectedCaseMultiplier);
}

function initializeRouletteVisuals(caseItem, multiplier) {
    const allReels = [rouletteReel1, rouletteReel2, rouletteReel3];
    allReels.forEach(reel => reel.classList.remove('active'));
    for (let i = 0; i < multiplier; i++) {
        if (allReels[i]) {
            allReels[i].classList.add('active');
            const spinner = allReels[i].querySelector('.roulette-spinner-reel');
            spinner.innerHTML = '';
            for (let j = 0; j < 50; j++) { // Populate with random items
                const randomPrize = caseItem.prizes[Math.floor(Math.random() * caseItem.prizes.length)];
                const itemEl = document.createElement('div');
                itemEl.className = 'roulette-item';
                itemEl.innerHTML = `<img src="${generateImageFilename(randomPrize.imageFilename || randomPrize.name)}" alt="${randomPrize.name}">`;
                spinner.appendChild(itemEl);
            }
            spinner.style.transition = 'none';
            spinner.style.top = `0px`;
        }
    }
}

async function spinRoulette() {
    if (!currentOpenCaseOrSlot) return;
    spinButton.disabled = true; spinButton.textContent = 'Spinning...';
    try {
        const result = await apiRequest('/api/open_case', 'POST', { case_id: currentOpenCaseOrSlot.id, multiplier: selectedCaseMultiplier });
        if (result.status === 'success' && result.won_prizes) {
            currentUser.tonBalance = result.new_balance_ton;
            updateBalances();
            const allReels = [rouletteReel1, rouletteReel2, rouletteReel3].filter(r => r.classList.contains('active'));
            allReels.forEach((reel, index) => {
                const spinner = reel.querySelector('.roulette-spinner-reel');
                const prize = result.won_prizes[index];
                if(prize) {
                    const finalItem = spinner.children[spinner.children.length - 5]; // Land on 5th from end
                    finalItem.innerHTML = `<img src="${generateImageFilename(prize.imageFilename || prize.name)}" alt="${prize.name}">`;
                    const itemHeight = 80;
                    const offset = finalItem.offsetTop - (reel.clientHeight / 2) + (itemHeight / 2);
                    spinner.style.transition = `top 6s cubic-bezier(0.25, 0.1, 0.2, 1)`;
                    spinner.style.top = `-${offset}px`;
                }
            });
            setTimeout(() => {
                showWinOverlay(result.won_prizes);
                result.won_prizes.forEach(p => { if(!p.is_ton_prize) currentUser.inventory.push(p); });
                renderInventory();
                spinButton.disabled = false; updateSpinButtonText();
            }, 6100);
        } else { spinButton.disabled = false; updateSpinButtonText(); }
    } catch (e) { spinButton.disabled = false; updateSpinButtonText(); }
}

function closeRouletteModal() { rouletteModal.classList.remove('active'); }

function showWinOverlay(prizes) {
    lastWonPrizesForOverlay = prizes;
    winOverlayPrizeImageContainer.innerHTML = '';
    let totalConvertValue = 0;
    prizes.forEach(p => {
        winOverlayPrizeImageContainer.innerHTML += `<img src="${generateImageFilename(p.imageFilename || p.name)}" alt="${p.name}">`;
        if(!p.is_ton_prize) totalConvertValue += p.currentValue;
    });
    winOverlayNameEl.textContent = prizes.length > 1 ? `You Won ${prizes.length} Items!` : `You Won: ${prizes[0].name}!`;
    winOverlayConvertValue.textContent = totalConvertValue.toFixed(2);
    winOverlayConvertBtn.style.display = totalConvertValue > 0 ? 'block' : 'none';
    winOverlayModal.classList.add('active');
}

function closeWinOverlayModal() { winOverlayModal.classList.remove('active'); }

async function handleSingleConvert(itemId) {
    try {
        const res = await apiRequest('/api/convert_to_ton', 'POST', { inventory_item_id: itemId });
        if (res.status === 'success') {
            currentUser.tonBalance = res.new_balance_ton;
            currentUser.inventory = currentUser.inventory.filter(i => i.id !== itemId);
            updateBalances(); renderInventory();
            showTGNotification('Item converted to TON!', 'success');
        }
    } catch (e) {}
}

async function handleConvertAll() {
    const itemsToConvert = lastWonPrizesForOverlay.filter(p => !p.is_ton_prize && p.id);
    for (const item of itemsToConvert) {
        await handleSingleConvert(item.id);
    }
    closeWinOverlayModal();
}

async function sellAllItems() {
    if (confirm(`Sell all non-TON items for ~${profileElements.sellAllValueSpan.textContent} TON?`)) {
        try {
            const res = await apiRequest('/api/sell_all_items', 'POST');
            if (res.status === 'success') {
                currentUser.tonBalance = res.new_balance_ton;
                currentUser.inventory = currentUser.inventory.filter(i => i.is_ton_prize);
                updateBalances(); renderInventory();
                showTGNotification(res.message, "success");
            }
        } catch (e) {}
    }
}

async function redeemPromocode() {
    const code = profileElements.promocodeInput.value.trim();
    if (!code) return;
    profileElements.redeemPromocodeButton.disabled = true;
    try {
        const res = await apiRequest('/api/redeem_promocode', 'POST', { promocode_text: code });
        if (res.status === 'success') {
            currentUser.tonBalance = res.new_balance_ton;
            updateBalances(); showTGNotification(res.message, 'success');
            profileElements.promocodeInput.value = '';
        }
    } catch (e) {}
    profileElements.redeemPromocodeButton.disabled = false;
}

async function renderInvitedFriendsList() {
    // This function remains the same, it will call the backend to get the list
    const listContainer = inviteElements.invitedUsersListDisplay;
    listContainer.innerHTML = '<div class="loader"></div>';
    try {
        const friends = await apiRequest('/api/get_invited_friends');
        if (friends && friends.length > 0) {
            listContainer.innerHTML = '';
            friends.forEach(friend => {
                const friendDiv = document.createElement('div');
                friendDiv.textContent = friend.name || `User #${friend.id}`;
                listContainer.appendChild(friendDiv);
            });
        } else {
            listContainer.innerHTML = '<p>No friends invited yet.</p>';
        }
    } catch (error) {
        listContainer.innerHTML = '<p style="color: var(--danger-color);">Could not load friends list.</p>';
    }
}

// All Upgrade functions (openUpgradeItemPicker, handleSelectInventoryItemForUpgrade, etc.) are also unchanged and copied here
function openUpgradeItemPicker(type) { currentUpgradePickerType = type; upgradePageElements.upgradeItemsGrid.innerHTML = ''; if (type === 'inventory') { upgradePageElements.upgradePickerTitle.textContent = "Select Your Item"; const inv = currentUser.inventory.filter(item => !item.is_ton_prize && item.currentValue > 0); if (inv.length === 0) { upgradePageElements.upgradeItemsGrid.innerHTML = '<p style="grid-column: 1/-1; text-align:center;">No upgradable items.</p>'; } else { inv.forEach(item => upgradePageElements.upgradeItemsGrid.appendChild(createUpgradeableItemCard(item, 'inventory'))); } } else if (type === 'desired') { if (!selectedItemForUpgrade) { showTGNotification("Select your item first.", "warning"); return; } upgradePageElements.upgradePickerTitle.textContent = "Select Desired Item"; const potential = allAppGiftsForUpgrade.filter(gift => gift.floorPrice > selectedItemForUpgrade.currentValue); if (potential.length === 0) { upgradePageElements.upgradeItemsGrid.innerHTML = '<p style="grid-column: 1/-1; text-align:center;">No higher value items available.</p>'; } else { potential.forEach(gift => upgradePageElements.upgradeItemsGrid.appendChild(createUpgradeableItemCard(gift, 'desired'))); } } upgradePageElements.upgradePickerContainer.style.display = 'block'; }
function closeUpgradeItemPicker() { upgradePageElements.upgradePickerContainer.style.display = 'none'; }
function createUpgradeableItemCard(itemData, type) { const card = document.createElement('div'); card.className = 'inventory-item'; card.innerHTML = `<div class="item-image-display"><img src="${itemData.imageFilename || generateImageFilename(itemData.name)}" alt="${itemData.name}"></div><div class="inventory-item-name">${itemData.name}</div><div class="inventory-item-value">${(type === 'inventory' ? itemData.currentValue : itemData.floorPrice).toFixed(2)} TON</div><div class="inventory-item-actions"><button class="button">Select</button></div>`; card.querySelector('button').onclick = () => type === 'inventory' ? handleSelectInventoryItemForUpgrade(itemData.id) : handleSelectDesiredItemForUpgrade(itemData.name); return card; }
function updateSlotDisplay(slot, itemData, type) { const ph = slot.querySelector('.slot-placeholder'); const disp = slot.querySelector('.slot-item-display'); if (itemData) { disp.querySelector('img').src = itemData.imageFilename || generateImageFilename(itemData.name); disp.querySelector('.slot-item-name').textContent = itemData.name; disp.querySelector('.slot-item-value').textContent = `${(type === 'inventory' ? itemData.currentValue : itemData.floorPrice).toFixed(2)} TON`; ph.style.display = 'none'; disp.style.display = 'flex'; disp.style.flexDirection = 'column'; } else { ph.style.display = 'flex'; disp.style.display = 'none'; } }
function handleSelectInventoryItemForUpgrade(itemId) { const item = currentUser.inventory.find(i => i.id === itemId); if (item) { selectedItemForUpgrade = { ...item }; updateSlotDisplay(upgradePageElements.selectedInventoryItemSlot, selectedItemForUpgrade, 'inventory'); desiredItemForUpgrade = null; updateSlotDisplay(upgradePageElements.desiredUpgradeItemSlot, null, 'desired'); calculateAndDisplayUpgradeStats(); closeUpgradeItemPicker(); } }
function handleSelectDesiredItemForUpgrade(itemName) { const item = allAppGiftsForUpgrade.find(g => g.name === itemName); if (item) { desiredItemForUpgrade = { ...item }; updateSlotDisplay(upgradePageElements.desiredUpgradeItemSlot, desiredItemForUpgrade, 'desired'); calculateAndDisplayUpgradeStats(); closeUpgradeItemPicker(); } }
function calculateAndDisplayUpgradeStats() { if (selectedItemForUpgrade && desiredItemForUpgrade) { calculatedUpgradeMultiplier = selectedItemForUpgrade.currentValue > 0 ? desiredItemForUpgrade.floorPrice / selectedItemForUpgrade.currentValue : 0; const x = Math.max(1.01, calculatedUpgradeMultiplier); const chance = 75 * Math.pow(0.60, x - 1); calculatedUpgradeChance = Math.min(75, Math.max(3, chance)); upgradePageElements.calculatedMultiplierText.textContent = `${calculatedUpgradeMultiplier.toFixed(2)}x`; upgradePageElements.calculatedChanceText.textContent = `${calculatedUpgradeChance.toFixed(1)}% Chance`; upgradePageElements.doUpgradeButton.disabled = false; upgradePageElements.doUpgradeButton.textContent = "Attempt Upgrade"; document.documentElement.style.setProperty('--upgrade-win-segment-angle', `${(calculatedUpgradeChance / 100) * 360}deg`); } else { upgradePageElements.calculatedMultiplierText.textContent = "--x"; upgradePageElements.calculatedChanceText.textContent = "--% Chance"; upgradePageElements.doUpgradeButton.disabled = true; upgradePageElements.doUpgradeButton.textContent = "Select Items"; document.documentElement.style.setProperty('--upgrade-win-segment-angle', `0deg`); } }
async function handleUpgrade() { if (!selectedItemForUpgrade || !desiredItemForUpgrade) return; upgradePageElements.doUpgradeButton.disabled = true; upgradePageElements.doUpgradeButton.textContent = "Upgrading..."; try { const res = await apiRequest('/api/upgrade_item_v2', 'POST', { inventory_item_id: selectedItemForUpgrade.id, desired_item_name: desiredItemForUpgrade.name }); await startUpgradeAnimation(res.status === 'success'); if (res.status === 'success') { currentUser.inventory = currentUser.inventory.filter(i => i.id !== selectedItemForUpgrade.id); currentUser.inventory.push(res.item); showUpgradeResultModal(true, selectedItemForUpgrade, res.item); } else { if (res.item_lost) currentUser.inventory = currentUser.inventory.filter(i => i.id !== selectedItemForUpgrade.id); showUpgradeResultModal(false, selectedItemForUpgrade, null); } renderInventory(); updateBalances(); } catch (e) {} finally { upgradePageElements.doUpgradeButton.disabled = false; } }
function startUpgradeAnimation(isSuccess) { const pointer = upgradePageElements.chancePointer; pointer.style.transition = 'none'; pointer.style.transform = `translateX(-50%) rotate(0deg)`; void pointer.offsetWidth; const winAngle = (calculatedUpgradeChance / 100) * 360; const targetAngle = isSuccess ? Math.random() * (winAngle - 10) + 5 : winAngle + Math.random() * (360 - winAngle - 10) + 5; const finalAngle = (3 + Math.floor(Math.random() * 3)) * 360 + targetAngle; pointer.style.transition = `transform 5s cubic-bezier(0.25, 0.1, 0.25, 1)`; pointer.style.transform = `translateX(-50%) rotate(${finalAngle}deg)`; return new Promise(resolve => setTimeout(resolve, 5100)); }
function showUpgradeResultModal(isSuccess, originalItem, newItem) { const modal = upgradePageElements.upgradeResultModal; modal.querySelector('#upgrade-result-title').textContent = isSuccess ? "Upgrade Successful!" : "Upgrade Failed"; modal.querySelector('#upgrade-result-title').style.color = isSuccess ? 'var(--success-color)' : 'var(--danger-color)'; modal.querySelector('#upgrade-result-message').textContent = isSuccess ? `Your ${originalItem.name} became ${newItem.name}!` : `You lost your ${originalItem.name}.`; modal.querySelector('#upgrade-result-image-container').innerHTML = `<img src="${(isSuccess ? newItem.imageFilename : originalItem.imageFilename) || generateImageFilename(isSuccess ? newItem.name : originalItem.name)}">`; modal.classList.add('active'); }
function closeUpgradeResultModal() { upgradePageElements.upgradeResultModal.classList.remove('active'); selectedItemForUpgrade = null; desiredItemForUpgrade = null; updateSlotDisplay(upgradePageElements.selectedInventoryItemSlot, null, 'inventory'); updateSlotDisplay(upgradePageElements.desiredUpgradeItemSlot, null, 'desired'); calculateAndDisplayUpgradeStats(); }

function updateLoadingStatus(message) {
    const statusElement = document.getElementById('loading-status');
    if (statusElement) {
        statusElement.textContent = message;
    }
}
    
// --- App Initialization ---
async function initializeApp() {
    updateLoadingStatus("Initializing application...");
    if (Telegram.WebApp && Telegram.WebApp.initDataUnsafe) {
        Telegram.WebApp.ready(); Telegram.WebApp.expand();
        const tgUser = Telegram.WebApp.initDataUnsafe.user;
        if(tgUser) { Object.assign(currentUser, tgUser); }
    }
    
    updateLoadingStatus("Loading user data...");
    await apiRequest('/api/get_user_data', 'POST').then(data => {
        Object.assign(currentUser, data);
        populateAllAppGifts();
    }).catch(() => { updateLoadingStatus("Failed to load user data. Please reload."); return; });
    
    updateLoadingStatus("Loading game content...");
    updateBalances();
    renderCases();
    renderProfile();
    // These can load in the background
    apiRequest('/api/get_leaderboard').then(data => { leaderboardList.innerHTML = ''; data.forEach(l => { const entry = document.createElement('div'); entry.className = 'leader-entry'; if(l.user_id === currentUser.id) entry.classList.add('current-user-entry'); entry.innerHTML = `<div class="rank">${l.rank}</div><div class="avatar-placeholder">${l.avatarChar}</div><div class="info"><div class="name">${l.name}</div><div class="details">User ID: ${String(l.user_id).slice(0, 6)}...</div></div><div class="score">${l.income.toFixed(2)} TON</div>`; leaderboardList.appendChild(entry); }); });
    inviteElements.referralLink.value = currentUser.referralCode ? `https://t.me/${BOT_USERNAME}?start=${currentUser.referralCode}` : 'Loading...';
    inviteElements.referralBalance.innerHTML = `${currentUser.referralEarningsPending.toFixed(2)} TON`;
    inviteElements.invitedCount.textContent = currentUser.invited_friends_count || 0;
    
    updateLoadingStatus("Ready!");
    loadingScreen.classList.add('hidden');
}

function populateAllAppGifts() {
    const uniqueGifts = new Map();
    casesData.forEach(c => c.prizes.forEach(p => { if (p.name && p.name !== 'Nothing' && !p.is_ton_prize) uniqueGifts.set(p.name, { name: p.name, imageFilename: generateImageFilename(p.imageFilename || p.name), floorPrice: 0 /* This should be set from a master list if available */ }); }));
    // In a real app, you'd fetch floor prices here. For now, we use what's in inventory.
    allAppGiftsForUpgrade = Array.from(uniqueGifts.values());
}


// --- Event Listeners ---
document.addEventListener('DOMContentLoaded', initializeApp);
appNavButtons.forEach(b => b.addEventListener('click', () => navigateToPage(b.dataset.page)));
spinButton.addEventListener('click', spinRoulette);
closeRouletteButton.addEventListener('click', closeRouletteModal);
winOverlaySaveBtn.addEventListener('click', closeWinOverlayModal);
winOverlayConvertBtn.addEventListener('click', handleConvertAll);
caseMultiplierSelector.querySelectorAll('button').forEach(btn => {
    btn.addEventListener('click', e => { selectedCaseMultiplier = parseInt(e.target.dataset.multiplier); updateCaseMultiplierButtons(); updateSpinButtonText(); });
});
profileElements.instantTopupButton.addEventListener('click', handleInstantTopup);
profileElements.redeemPromocodeButton.addEventListener('click', redeemPromocode);
profileElements.sellAllButton?.addEventListener('click', sellAllItems);
closeWithdrawModalButton.addEventListener('click', closeWithdrawModal);
inviteElements.copyRefLinkButton.addEventListener('click', () => { navigator.clipboard.writeText(inviteElements.referralLink.value).then(() => showTGNotification("Copied!", 'success')); });
inviteElements.withdrawReferralButton.addEventListener('click', async () => { try { const res = await apiRequest('/api/withdraw_referral_earnings', 'POST'); if(res.status === 'success') { currentUser.tonBalance = res.new_balance_ton; currentUser.referralEarningsPending = res.new_referral_earnings_pending; updateBalances(); inviteElements.referralBalance.textContent = '0.00 TON'; showTGNotification('Withdrawn!', 'success'); }} catch(e){} });
upgradePageElements.selectedInventoryItemSlot.addEventListener('click', () => openUpgradeItemPicker('inventory'));
upgradePageElements.desiredUpgradeItemSlot.addEventListener('click', () => openUpgradeItemPicker('desired'));
upgradePageElements.closeUpgradePickerButton.addEventListener('click', closeUpgradeItemPicker);
upgradePageElements.doUpgradeButton.addEventListener('click', handleUpgrade);
upgradePageElements.closeUpgradeResultModalButton.addEventListener('click', closeUpgradeResultModal);

</script>
</body>
</html>
